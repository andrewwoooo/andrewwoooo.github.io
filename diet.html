<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>断食记录器</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#0f172a;--panel:#111827;--border:#1f2937;--muted:#9ca3af;--text:#e5e7eb;
      --primary:#22d3ee;--accent:#34d399;--danger:#f87171;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"PingFang SC","Noto Sans SC","Microsoft YaHei",sans-serif;}
    header{padding:12px;background:var(--panel);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;position:sticky;top:0;z-index:10}
    header img{height:40px}
    h1{margin:0;font-size:20px}
    main{padding:16px;display:grid;gap:16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    label{font-size:13px;color:var(--muted)}
    input{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#0b1220;color:var(--text)}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#0b1220;color:var(--text);font-weight:600}
    .btn-primary{border-color:var(--primary);color:var(--primary)}
    .btn-accent{border-color:var(--accent);color:var(--accent)}
    .btn-danger{border-color:var(--danger);color:var(--danger)}
    .btn:active{transform:scale(0.98)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:8px;font-size:13px}
    th{text-align:left;color:var(--muted)}
    tfoot td{color:var(--muted)}
    canvas{width:100%!important;height:260px!important}
    .note{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo" onerror="this.style.display='none'">
    <h1>断食记录器</h1>
  </header>

  <main>
    <!-- 计时器与输入 -->
    <section class="card" id="timerCard">
      <div class="row">
        <div>状态：<strong id="statusText">未开始</strong></div>
        <div>已断食：<strong id="elapsedText">00:00:00</strong></div>
      </div>
      <div class="row">
        <button class="btn btn-primary" id="startBtn">开始</button>
        <button class="btn btn-accent" id="endBtn" disabled>结束</button>
        <button class="btn" id="resetBtn">重置</button>
      </div>
      <div class="grid-2" style="margin-top:8px">
        <div>
          <label for="targetHours">目标时长（小时）</label>
          <input id="targetHours" type="number" min="1" step="1" placeholder="例如 16">
        </div>
        <div>
          <label for="note">备注</label>
          <input id="note" type="text" placeholder="心情、饮食、能量等">
        </div>
      </div>
      <div class="grid-2" style="margin-top:8px">
        <div>
          <label for="weight">体重（kg）</label>
          <input id="weight" type="number" step="0.1" placeholder="例如 65.5">
        </div>
        <div class="row">
          <button class="btn" id="remindBtn">设置提醒</button>
          <span class="note" id="etaText">预计结束时间：—</span>
        </div>
      </div>
      <p class="note">提示：若允许浏览器通知，提醒更可靠；否则会回退为弹窗提醒。</p>
    </section>

    <!-- 汇总 -->
    <section class="card" id="summaryCard">
      <div class="grid-2">
        <div>累计记录：<strong id="totalSessions">0</strong></div>
        <div>最近一周平均断食：<strong id="avgWeek">—</strong></div>
      </div>
      <div class="grid-2" style="margin-top:8px">
        <div>最近一周平均体重：<strong id="avgWeight">—</strong></div>
        <div>最近一周断食总时长：<strong id="sumWeek">—</strong></div>
      </div>
    </section>

    <!-- 图表：断食 -->
    <section class="card" id="fastingChartCard">
      <div class="row" style="justify-content:space-between">
        <strong>断食趋势</strong>
        <div class="row">
          <button class="btn" data-view="daily" id="fastingDailyBtn">按日</button>
          <button class="btn" data-view="monthly" id="fastingMonthlyBtn">按月</button>
        </div>
      </div>
      <canvas id="trendChart"></canvas>
    </section>

    <!-- 图表：体重 -->
    <section class="card" id="weightChartCard">
      <strong>体重趋势</strong>
      <canvas id="weightChart"></canvas>
    </section>

    <!-- 记录与导出 -->
    <section class="card" id="recordsCard">
      <div class="row" style="justify-content:space-between;align-items:center">
        <strong>记录表</strong>
        <div class="row">
          <button class="btn" id="exportBtn">导出 CSV</button>
          <button class="btn btn-danger" id="clearAllBtn">清空全部</button>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>日期</th>
            <th>开始</th>
            <th>结束</th>
            <th>时长</th>
            <th>体重</th>
            <th>备注</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="recordsTbody"></tbody>
        <tfoot><tr><td colspan="7" id="recordsFooter" class="note">暂无记录</td></tr></tfoot>
      </table>
    </section>

    <p class="note">iPhone 上可通过 Safari 的“添加到主屏幕”获得更接近原生的体验。</p>
  </main>

  <script>
    // 工具函数
    const $ = sel => document.querySelector(sel);
    const fmtTime = ms => {
      const s = Math.floor(ms / 1000);
      const h = String(Math.floor(s / 3600)).padStart(2, '0');
      const m = String(Math.floor((s % 3600) / 60)).padStart(2, '0');
      const sec = String(s % 60).padStart(2, '0');
      return `${h}:${m}:${sec}`;
    };
    const fmtDate = ts => {
      const d = new Date(ts);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    };
    const fmtHM = ts => {
      const d = new Date(ts);
      const h = String(d.getHours()).padStart(2,'0');
      const m = String(d.getMinutes()).padStart(2,'0');
      return `${h}:${m}`;
    };

    // 存储
    const STORE_REC = 'fasting_records_v2';
    const STORE_STATE = 'fasting_state_v2';
    let records = JSON.parse(localStorage.getItem(STORE_REC) || '[]'); // [{id,date,start,end,durationMs,weight,note}]
    let state = JSON.parse(localStorage.getItem(STORE_STATE) || '{}'); // {startTime,targetHours,note}
    let timerInterval = null;
    let reminderHandle = null;

    const saveAll = () => {
      localStorage.setItem(STORE_REC, JSON.stringify(records));
      localStorage.setItem(STORE_STATE, JSON.stringify(state));
    };

    // 通知
    async function ensureNotificationPermission(){
      if(!('Notification' in window)) return false;
      if(Notification.permission === 'granted') return true;
      if(Notification.permission === 'denied') return false;
      const res = await Notification.requestPermission();
      return res === 'granted';
    }
    function scheduleReminder(endTs){
      clearTimeout(reminderHandle);
      const delay = endTs - Date.now();
      if(delay <= 0) return;
      reminderHandle = setTimeout(async ()=>{
        const granted = await ensureNotificationPermission();
        const title = '断食时间到';
        const body = '你已达到目标时长，可以结束断食或继续保持。';
        if(granted){
          try{ new Notification(title, { body }); }
          catch{ alert(`${title}\n${body}`); }
        }else{
          alert(`${title}\n${body}`);
        }
      }, delay);
    }

    // UI 更新
    function updateUI(){
      const running = !!state.startTime;
      $('#statusText').textContent = running ? '进行中' : '未开始';
      $('#startBtn').disabled = running;
      $('#endBtn').disabled = !running;
      $('#elapsedText').textContent = running ? fmtTime(Date.now()-state.startTime) : '00:00:00';

      // ETA
      const th = Number($('#targetHours').value) || state.targetHours || null;
      if(running && th && th > 0){
        const eta = state.startTime + th * 3600 * 1000;
        $('#etaText').textContent = `预计结束时间：${fmtDate(eta)} ${fmtHM(eta)}`;
      }else{
        $('#etaText').textContent = '预计结束时间：—';
      }

      renderRecords();
      updateSummary();
      renderFastingChart();
      renderWeightChart();
    }

    // 计时器控制
    function startTimer(){
      if(state.startTime) return;
      state.startTime = Date.now();
      state.targetHours = Number($('#targetHours').value) || null;
      state.note = ($('#note').value || '').trim();
      saveAll();

      if(state.targetHours && state.targetHours > 0){
        scheduleReminder(state.startTime + state.targetHours * 3600 * 1000);
      }

      clearInterval(timerInterval);
      timerInterval = setInterval(()=>$('#elapsedText').textContent = fmtTime(Date.now()-state.startTime), 500);
      updateUI();
    }
    function endTimer(){
      if(!state.startTime) return;
      const end = Date.now();
      const weight = Number($('#weight').value) || null;
      records.unshift({
        id: `${state.startTime}-${end}`,
        date: fmtDate(state.startTime),
        start: state.startTime,
        end,
        durationMs: end - state.startTime,
        weight,
        note: state.note || ($('#note').value || '').trim()
      });
      // reset
      state.startTime = null;
      saveAll();
      clearInterval(timerInterval);
      clearTimeout(reminderHandle);
      timerInterval = null;
      reminderHandle = null;
      updateUI();
    }
    function resetTimer(){
      state.startTime = null;
      saveAll();
      clearInterval(timerInterval);
      clearTimeout(reminderHandle);
      timerInterval = null;
      reminderHandle = null;
      updateUI();
    }

    // 记录表
    function renderRecords(){
      const tbody = $('#recordsTbody');
      const footer = $('#recordsFooter');
      tbody.innerHTML = '';
      if(records.length === 0){
        footer.textContent = '暂无记录';
        return;
      }
      footer.textContent = '';
      records.forEach((r, idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.date}</td>
          <td>${fmtHM(r.start)}</td>
          <td>${fmtHM(r.end)}</td>
          <td>${fmtTime(r.durationMs)}</td>
          <td>${r.weight ? r.weight+' kg' : ''}</td>
          <td>${r.note || ''}</td>
          <td><button class="btn btn-danger">删除</button></td>
        `;
        tr.querySelector('button').onclick = ()=>{
          records.splice(idx,1);
          saveAll();
          updateUI();
        };
        tbody.appendChild(tr);
      });
    }

    // 汇总
    function updateSummary(){
      $('#totalSessions').textContent = String(records.length);
      const now = Date.now();
      const sevenAgo = now - 7*24*3600*1000;
      const week = records.filter(r => r.start >= sevenAgo);

      if(week.length){
        const avgDurH = week.reduce((s,r)=>s+r.durationMs,0)/week.length/3600000;
        const sumDurH = week.reduce((s,r)=>s+r.durationMs,0)/3600000;
        $('#avgWeek').textContent = `${avgDurH.toFixed(1)} 小时`;
        $('#sumWeek').textContent = `${sumDurH.toFixed(1)} 小时`;

        const weights = week.filter(r=>typeof r.weight === 'number').map(r=>r.weight);
        $('#avgWeight').textContent = weights.length ? `${(weights.reduce((s,w)=>s+w,0)/weights.length).toFixed(1)} kg` : '—';
      }else{
        $('#avgWeek').textContent = '—';
        $('#sumWeek').textContent = '—';
        $('#avgWeight').textContent = '—';
      }
    }

    // 图表数据聚合
    function groupDailyHours(recs){
      const m = new Map();
      recs.forEach(r=>{
        const key = fmtDate(r.start);
        m.set(key, (m.get(key)||0) + r.durationMs);
      });
      return Array.from(m.entries()).sort((a,b)=>a[0].localeCompare(b[0])).map(([d,ms])=>({x:d,y:ms/3600000}));
    }
    function groupMonthlyHours(recs){
      const m = new Map();
      recs.forEach(r=>{
        const d = new Date(r.start);
        const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        m.set(key, (m.get(key)||0) + r.durationMs);
      });
      return Array.from(m.entries()).sort((a,b)=>a[0].localeCompare(b[0])).map(([d,ms])=>({x:d,y:ms/3600000}));
    }
    function weightPoints(recs){
      const byDay = new Map();
      recs.forEach(r=>{
        if(typeof r.weight === 'number'){
          const key = fmtDate(r.start);
          // 如果同一天有多个体重记录，这里以最后一次为准
          byDay.set(key, r.weight);
        }
      });
      return Array.from(byDay.entries()).sort((a,b)=>a[0].localeCompare(b[0])).map(([d,w])=>({x:d,y:w}));
    }

    // 图表渲染
    let fastingView = 'daily'; // 'daily' | 'monthly'
    let fastingChart = null;
    let weightChart = null;

    function renderFastingChart(){
      const ctx = document.getElementById('trendChart');
      const points = fastingView === 'daily' ? groupDailyHours(records) : groupMonthlyHours(records);
      const labels = points.map(p=>p.x);
      const data = points.map(p=>p.y);
      if(fastingChart) fastingChart.destroy();
      fastingChart = new Chart(ctx, {
        type:'line',
        data:{ labels, datasets:[{ label: fastingView==='daily'?'每日累计断食小时':'每月累计断食小时', data, borderColor:'#22d3ee', backgroundColor:'rgba(34,211,238,0.2)', tension:0.3 }] },
        options:{
          responsive:true,
          plugins:{ legend:{ labels:{ color:'#e5e7eb' } } },
          scales:{ x:{ ticks:{ color:'#9ca3af' }, grid:{ color:'#1f2937' } }, y:{ ticks:{ color:'#9ca3af' }, grid:{ color:'#1f2937' } } }
        }
      });
    }
    function renderWeightChart(){
      const ctx = document.getElementById('weightChart');
      const points = weightPoints(records);
      const labels = points.map(p=>p.x);
      const data = points.map(p=>p.y);
      if(weightChart) weightChart.destroy();
      weightChart = new Chart(ctx,{
        type:'line',
        data:{ labels, datasets:[{ label:'体重 (kg)', data, borderColor:'#34d399', backgroundColor:'rgba(52,211,153,0.2)', tension:0.3 }] },
        options:{
          responsive:true,
          plugins:{ legend:{ labels:{ color:'#e5e7eb' } } },
          scales:{ x:{ ticks:{ color:'#9ca3af' }, grid:{ color:'#1f2937' } }, y:{ ticks:{ color:'#9ca3af' }, grid:{ color:'#1f2937' } } }
        }
      });
    }

    // 导出 CSV
    function exportCSV(){
      const header = ['日期','开始','结束','时长(小时)','体重(kg)','备注'];
      const rows = records.map(r=>[
        fmtDate(r.start),
        fmtHM(r.start),
        fmtHM(r.end),
        (r.durationMs/3600000).toFixed(2),
        (typeof r.weight === 'number') ? r.weight : '',
        r.note || ''
      ]);
      const csv = [header, ...rows].map(line => line.map(v=>{
        const s = String(v ?? '');
        // 处理逗号与换行，加入双引号包裹
        if(s.includes(',') || s.includes('\n') || s.includes('"')) return `"${s.replace(/"/g,'""')}"`;
        return s;
      }).join(',')).join('\n');
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'fasting_records.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // 事件绑定
    $('#startBtn').addEventListener('click', startTimer);
    $('#endBtn').addEventListener('click', endTimer);
    $('#resetBtn').addEventListener('click', resetTimer);

    $('#targetHours').addEventListener('input', ()=>{
      const v = Number($('#targetHours').value);
      state.targetHours = Number.isFinite(v) && v>0 ? v : null;
      saveAll(); updateUI();
    });
    $('#note').addEventListener('input', ()=>{
      state.note = ($('#note').value || '').trim();
      saveAll();
    });
    $('#remindBtn').addEventListener('click', async ()=>{
      if(!state.startTime){ alert('请先开始断食再设置提醒。'); return; }
      const th = Number($('#targetHours').value) || state.targetHours;
      if(!(th && th>0)){ alert('请设置目标时长（小时）后再提醒。'); return; }
      const ok = await ensureNotificationPermission();
      if(!ok){ alert('已使用弹窗作为提醒备选。若需系统通知，请允许通知权限。'); }
      const endTs = state.startTime + th*3600*1000;
      scheduleReminder(endTs);
      alert(`已设置提醒：${fmtDate(endTs)} ${fmtHM(endTs)}`);
    });

    $('#clearAllBtn').addEventListener('click', ()=>{
      if(confirm('确认清空全部记录？此操作不可恢复。')){
        records = [];
        saveAll();
        updateUI();
      }
    });
    $('#exportBtn').addEventListener('click', exportCSV);

    $('#fastingDailyBtn').addEventListener('click', ()=>{ fastingView='daily'; renderFastingChart(); });
    $('#fastingMonthlyBtn').addEventListener('click', ()=>{ fastingView='monthly'; renderFastingChart(); });

    // 初始化
    function init(){
      // 恢复输入框
      if(state.targetHours) $('#targetHours').value = state.targetHours;
      if(state.note) $('#note').value = state.note;
      if(state.startTime){
        clearInterval(timerInterval);
        timerInterval = setInterval(()=>$('#elapsedText').textContent = fmtTime(Date.now()-state.startTime), 500);
      }
      updateUI();
    }
    init();
  </script>
</body>
</html>