<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>断食记录器</title>
<style>
  :root{
    --bg:#0f172a;--panel:#111827;--border:#1f2937;--muted:#9ca3af;--text:#e5e7eb;
    --primary:#22d3ee;--accent:#34d399;--danger:#f87171;
  }
  body{margin:0;background:var(--bg);color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"PingFang SC",Arial,sans-serif;}
  header{padding:14px;text-align:center;background:var(--panel);font-size:18px;font-weight:600}
  main{padding:16px;display:flex;flex-direction:column;gap:16px}
  .card{background:var(--panel);border-radius:12px;padding:16px}
  .row{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
  .btn{flex:1;padding:12px;border-radius:10px;border:none;font-weight:600;cursor:pointer}
  .btn-primary{background:var(--primary);color:#0f172a}
  .btn-accent{background:var(--accent);color:#0f172a}
  .btn-danger{background:var(--danger);color:#0f172a}
  label{font-size:13px;color:var(--muted);display:block;margin-top:10px}
  input{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);
    background:#0b1220;color:var(--text)}
  .record{background:#0b1220;border-radius:10px;padding:10px;margin-top:8px}
  .record strong{display:block;font-size:14px}
</style>
</head>
<body>
<header>断食记录器</header>
<main>
  <!-- 倒计时 -->
  <section class="card">
    <div>状态：<strong id="statusText">未开始</strong></div>
    <div>剩余时间：<strong id="countdownText">00:00:00</strong></div>
    <div>预计结束时间：<strong id="etaText">—</strong></div>
    <div class="row">
      <button class="btn btn-primary" id="startBtn">开始倒计时</button>
      <button class="btn btn-accent" id="endBtn" disabled>结束断食</button>
      <button class="btn btn-danger" id="resetBtn">重置</button>
    </div>
  </section>

  <!-- 输入 -->
  <section class="card">
    <label>目标时长（小时）</label>
    <input id="targetHours" type="number" placeholder="例如 16">
    <label>备注</label>
    <input id="note" type="text" placeholder="心情、遇到的情况">
  </section>

  <!-- 记录 -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <strong>记录</strong>
      <button class="btn btn-accent" id="exportBtn">导出 CSV</button>
    </div>
    <div id="recordsList"></div>
  </section>
</main>

<script>
const $ = sel => document.querySelector(sel);
const fmtTime = ms => {
  const s = Math.floor(ms/1000);
  const h = String(Math.floor(s/3600)).padStart(2,'0');
  const m = String(Math.floor((s%3600)/60)).padStart(2,'0');
  const sec = String(s%60).padStart(2,'0');
  return `${h}:${m}:${sec}`;
};
const fmtDateTime = ts => {
  const d = new Date(ts);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
};

let records = JSON.parse(localStorage.getItem('fasting_records')||'[]');
let state = JSON.parse(localStorage.getItem('fasting_state')||'{}');
let timerInterval=null;

function saveAll(){
  localStorage.setItem('fasting_records',JSON.stringify(records));
  localStorage.setItem('fasting_state',JSON.stringify(state));
}

function updateUI(){
  const running=!!state.startTime;
  $('#statusText').textContent=running?'进行中':'未开始';
  $('#startBtn').disabled=running;
  $('#endBtn').disabled=!running;
  if(running){
    const remaining=state.endTime-Date.now();
    $('#countdownText').textContent=remaining>0?fmtTime(remaining):'已到期';
    $('#etaText').textContent=fmtDateTime(state.endTime);
  }else{
    $('#countdownText').textContent='00:00:00';
    $('#etaText').textContent='—';
  }
  renderRecords();
}

function startTimer(){
  const hours=Number($('#targetHours').value);
  if(!hours||hours<=0){alert('请输入有效的目标时长');return;}
  state.startTime=Date.now();
  state.endTime=state.startTime+hours*3600*1000;
  state.note=$('#note').value||'';
  saveAll();
  clearInterval(timerInterval);
  timerInterval=setInterval(updateUI,1000);
  updateUI();
}
function endTimer(){
  if(!state.startTime) return;
  const end=Date.now();
  records.unshift({
    date:fmtDateTime(state.startTime),
    start:state.startTime,
    end,
    durationMs:end-state.startTime,
    note:state.note||$('#note').value||''
  });
  state.startTime=null;
  saveAll();
  clearInterval(timerInterval);
  timerInterval=null;
  updateUI();
}
function resetTimer(){
  state.startTime=null;
  saveAll();
  clearInterval(timerInterval);
  timerInterval=null;
  updateUI();
}

function renderRecords(){
  const list=$('#recordsList');
  list.innerHTML='';
  if(records.length===0){list.textContent='暂无记录';return;}
  records.forEach(r=>{
    const div=document.createElement('div');
    div.className='record';
    div.innerHTML=`<strong>${r.date}</strong>
      总时长：${(r.durationMs/3600000).toFixed(1)} 小时
      ${r.note?'<br>备注：'+r.note:''}`;
    list.appendChild(div);
  });
}

// 导出 CSV
function exportCSV(){
  const header=['开始时间','结束时间','总时长(小时)','备注'];
  const rows=records.map(r=>[
    fmtDateTime(r.start),
    fmtDateTime(r.end),
    (r.durationMs/3600000).toFixed(2),
    r.note||''
  ]);
  const csv=[header,...rows].map(line=>line.map(v=>{
    const s=String(v??'');
    if(s.includes(',')||s.includes('\n')||s.includes('"')) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download='fasting_records.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

$('#startBtn').addEventListener('click',startTimer);
$('#endBtn').addEventListener('click',endTimer);
$('#resetBtn').addEventListener('click',resetTimer);
$('#exportBtn').addEventListener('click',exportCSV);

if(state.startTime){
  timerInterval=setInterval(updateUI,1000);
}
updateUI();
</script>
</body>
</html>
